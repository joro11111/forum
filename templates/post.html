{{define "content"}}
<div class="card">
    <h1>{{.Post.Title}}</h1>
    
    <div class="post-meta">
        <strong><a href="/profile/{{.Post.Username}}" style="color: #3498db; text-decoration: none;">{{.Post.Username}}</a></strong> in <strong>{{.Post.CategoryName}}</strong> â€¢ 
        {{.Post.CreatedAt.Format "January 2, 2006 at 3:04 PM"}}
    </div>
    
    <div class="post-content">
        {{.Post.Content}}
    </div>
    
    <div class="post-actions">
        {{if .CurrentUser}}
            <form method="POST" action="/like-post" class="like-form">
                <input type="hidden" name="post_id" value="{{.Post.ID}}">
                <input type="hidden" name="action" value="like">
                <button type="submit" class="like-btn">ğŸ‘ {{.Post.LikesCount}}</button>
            </form>
            
            <form method="POST" action="/like-post" class="like-form">
                <input type="hidden" name="post_id" value="{{.Post.ID}}">
                <input type="hidden" name="action" value="dislike">
                <button type="submit" class="like-btn">ğŸ‘ {{.Post.DislikesCount}}</button>
            </form>
        {{else}}
            <span class="like-btn">ğŸ‘ {{.Post.LikesCount}}</span>
            <span class="like-btn">ğŸ‘ {{.Post.DislikesCount}}</span>
        {{end}}
    </div>
</div>

<div class="comments-section">
    <h3>ğŸ’¬ Comments ({{.FormData.total_comments}})</h3>
    
    <!-- Display top-level comments -->
    {{$pageData := .}}
    {{range .CommentTrees}}
        {{template "renderComment" (dict "Comment" . "PageData" $pageData)}}
    {{else}}
        <p style="text-align: center; color: #7f8c8d; font-style: italic;">No comments yet. Be the first to comment!</p>
    {{end}}
</div>

  {{if .CurrentUser}}
        <div class="card">
            <h4>Add a Comment</h4>
            <form method="POST" action="/create-comment">
                <input type="hidden" name="post_id" value="{{.Post.ID}}">
                <div class="form-group">
                    <textarea name="content" class="form-control" rows="5" cols="50" placeholder="Share your thoughts..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Post Comment</button>
            </form>
        </div>
    {{end}}

<script>
function toggleReplyForm(commentId) {
    var replyForm = document.getElementById('reply-form-' + commentId);
    if (replyForm.style.display === 'none') {
        replyForm.style.display = 'block';
    } else {
        replyForm.style.display = 'none';
    }
}
</script>
{{end}}

{{define "renderComment"}}
    {{$comment := .Comment}}
    {{$pageData := .PageData}}
    <div class="comment{{if $comment.ParentID}} reply{{end}}" id="comment-{{$comment.ID}}">
        <div class="comment-meta">
            <strong><a href="/profile/{{$comment.Username}}" style="color: #3498db; text-decoration: none;">{{$comment.Username}}</a></strong> â€¢ {{$comment.CreatedAt.Format "January 2, 2006 at 3:04 PM"}}
        </div>
        <div>{{$comment.Content}}</div>
        
        <div class="post-actions">
            {{if $pageData.CurrentUser}}
                <form method="POST" action="/like-comment" class="like-form">
                    <input type="hidden" name="comment_id" value="{{$comment.ID}}">
                    <input type="hidden" name="action" value="like">
                    <button type="submit" class="like-btn btn-sm">ğŸ‘ {{$comment.LikesCount}}</button>
                </form>
                
                <form method="POST" action="/like-comment" class="like-form">
                    <input type="hidden" name="comment_id" value="{{$comment.ID}}">
                    <input type="hidden" name="action" value="dislike">
                    <button type="submit" class="like-btn btn-sm">ğŸ‘ {{$comment.DislikesCount}}</button>
                </form>
                
                <button type="button" class="reply-btn btn-sm" onclick="toggleReplyForm({{$comment.ID}})">ğŸ’¬ Reply</button>
            {{else}}
                <span class="like-btn btn-sm">ğŸ‘ {{$comment.LikesCount}}</span>
                <span class="like-btn btn-sm">ğŸ‘ {{$comment.DislikesCount}}</span>
            {{end}}
        </div>
        
        {{if $pageData.CurrentUser}}
            <!-- Reply form (initially hidden) -->
            <div id="reply-form-{{$comment.ID}}" class="reply-form" style="display: none;">
                <form method="POST" action="/create-comment">
                    <input type="hidden" name="post_id" value="{{$pageData.Post.ID}}">
                    <input type="hidden" name="parent_id" value="{{$comment.ID}}">
                    <div class="form-group">
                        <textarea name="content" class="form-control" rows="3" placeholder="Write your reply..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">Post Reply</button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="toggleReplyForm({{$comment.ID}})">Cancel</button>
                </form>
            </div>
        {{end}}
        
        <!-- Display replies recursively -->
        {{range $comment.Replies}}
            {{template "renderComment" (dict "Comment" . "PageData" $pageData)}}
        {{end}}
    </div>
{{end}} 

