{{define "content"}}
<main>
   
    <div class="filters">
        <h3>üîç Filter Posts</h3>
        <div class="filter-options">
            <a href="/" class="filter-btn {{if not .Filter}}active{{end}}">All Posts</a>
            {{if .CurrentUser}}
                <a href="/?filter=my-posts" class="filter-btn {{if eq .Filter "my-posts"}}active{{end}}">My Posts</a>
                <a href="/?filter=liked-posts" class="filter-btn {{if eq .Filter "liked-posts"}}active{{end}}">Liked Posts</a>
            {{end}}
        </div>

        <!-- Dropdown for small screens -->
        <div class="select-wrapper">
            <label for="category-select" class="sr-only">Filter by Category</label>
            <select id="category-select" onchange="updateCategoryFilter()">
                <option value="">All Categories</option>
                {{range .Categories}}
                    <option value="{{.ID}}" {{if eq $.CategoryID (printf "%d" .ID)}}selected{{end}}>{{.Name}}</option>
                {{end}}
            </select>
        </div>

        <!-- List for larger screens -->
        <div class="categories-wrapper">
            <h4>Categories</h4>
            <ul class="categories-list">
                <li><a href="/?category=" class="category-btn {{if not $.CategoryID}}active{{end}}">All Categories</a></li>
                {{range .Categories}}
                    <li><a href="/?category={{.ID}}" class="category-btn {{if eq $.CategoryID (printf "%d" .ID)}}active{{end}}">{{.Name}}</a></li>
                {{end}}
            </ul>
        </div>

        <!-- Sorting options -->
        <div class="sorting-wrapper">
            <h4>Sort Posts</h4>
            <div class="sort-options">
                <div class="sort-by">
                    <label for="sort-by">Sort by:</label>
                    <select id="sort-by" onchange="updateSorting()">
                        <option value="date" {{if eq .SortBy "date"}}selected{{end}}>Date</option>
                        <option value="likes" {{if eq .SortBy "likes"}}selected{{end}}>Likes</option>
                        <option value="comments" {{if eq .SortBy "comments"}}selected{{end}}>Comments</option>
                        <option value="title" {{if eq .SortBy "title"}}selected{{end}}>Title</option>
                    </select>
                </div>
                <div class="sort-order">
                    <label for="sort-order">Order:</label>
                    <select id="sort-order" onchange="updateSorting()">
                        <option value="desc" {{if eq .SortOrder "desc"}}selected{{end}}>
                            <span class="sort-desc">{{if eq .SortBy "date"}}Newest First{{else if eq .SortBy "likes"}}Most Liked{{else if eq .SortBy "comments"}}Most Comments{{else if eq .SortBy "title"}}Z-A{{else}}Descending{{end}}</span>
                        </option>
                        <option value="asc" {{if eq .SortOrder "asc"}}selected{{end}}>
                            <span class="sort-asc">{{if eq .SortBy "date"}}Oldest First{{else if eq .SortBy "likes"}}Least Liked{{else if eq .SortBy "comments"}}Least Comments{{else if eq .SortBy "title"}}A-Z{{else}}Ascending{{end}}</span>
                        </option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="posts-section">
        {{if .Posts}}
            {{range .Posts}}
            <div class="card">
                <h2><a href="/post/{{.ID}}" class="post-title">{{.Title}}</a></h2>
                <div class="post-meta">
                    <strong><a href="/profile/{{.Username}}" class="username-link">{{.Username}}</a></strong> in <strong>{{.CategoryName}}</strong> ‚Ä¢ 
                    {{.CreatedAt.Format "January 2, 2006 at 3:04 PM"}}
                </div>
                <div class="post-content">
                    {{if gt (len .Content) 300}}
                        {{slice .Content 0 300}}...
                    {{else}}
                        {{.Content}}
                    {{end}}
                </div>
                <div class="post-actions">
                    {{if $.CurrentUser}}
                        <form method="POST" action="/like-post" class="like-form">
                            <input type="hidden" name="post_id" value="{{.ID}}">
                            <input type="hidden" name="action" value="like">
                            <button type="submit" class="like-btn btn-sm">üëç {{.LikesCount}}</button>
                        </form>
                        <form method="POST" action="/like-post" class="like-form">
                            <input type="hidden" name="post_id" value="{{.ID}}">
                            <input type="hidden" name="action" value="dislike">
                            <button type="submit" class="like-btn btn-sm">üëé {{.DislikesCount}}</button>
                        </form>
                    {{else}}
                        <span class="like-btn btn-sm">üëç {{.LikesCount}}</span>
                        <span class="like-btn btn-sm">üëé {{.DislikesCount}}</span>
                    {{end}}
                    <span class="like-btn btn-sm">üí¨ {{.CommentsCount}} comments</span>
                    <a href="/post/{{.ID}}" class="like-btn btn-sm">Comment</a>
                </div>
            </div>
            {{end}}
        {{else}}
            <div class="card">
                <h2>üìö No Posts Yet</h2>
                <p>No posts available for the selected filter.</p>
            </div>
        {{end}}
    </div>
</main>

<script>
function updateCategoryFilter() {
    const categorySelect = document.getElementById('category-select');
    const categoryID = categorySelect.value;
    
    // Get current filter and sort parameters
    const urlParams = new URLSearchParams(window.location.search);
    const filter = urlParams.get('filter') || '';
    const sortBy = urlParams.get('sort_by') || 'date';
    const sortOrder = urlParams.get('sort_order') || 'desc';
    
    // Build new URL
    let newUrl = '/?';
    if (filter) newUrl += `filter=${filter}&`;
    if (categoryID) newUrl += `category=${categoryID}&`;
    if (sortBy) newUrl += `sort_by=${sortBy}&`;
    if (sortOrder) newUrl += `sort_order=${sortOrder}&`;
    
    // Remove trailing '&' or '?' if present
    newUrl = newUrl.replace(/[&?]$/, '');
    
    window.location.href = newUrl;
}

function updateSorting() {
    const sortBySelect = document.getElementById('sort-by');
    const sortOrderSelect = document.getElementById('sort-order');
    const sortBy = sortBySelect.value;
    const sortOrder = sortOrderSelect.value;
    
    // Get current filter and category parameters
    const urlParams = new URLSearchParams(window.location.search);
    const filter = urlParams.get('filter') || '';
    const categoryID = urlParams.get('category') || '';
    
    // Build new URL
    let newUrl = '/?';
    if (filter) newUrl += `filter=${filter}&`;
    if (categoryID) newUrl += `category=${categoryID}&`;
    if (sortBy) newUrl += `sort_by=${sortBy}&`;
    if (sortOrder) newUrl += `sort_order=${sortOrder}&`;
    
    // Remove trailing '&' or '?' if present
    newUrl = newUrl.replace(/[&?]$/, '');
    
    window.location.href = newUrl;
}

// Update sort order options text based on sort by selection
document.getElementById('sort-by').addEventListener('change', function() {
    const sortBy = this.value;
    const sortOrderSelect = document.getElementById('sort-order');
    const descOption = sortOrderSelect.querySelector('option[value="desc"]');
    const ascOption = sortOrderSelect.querySelector('option[value="asc"]');
    
    switch(sortBy) {
        case 'date':
            descOption.text = 'Newest First';
            ascOption.text = 'Oldest First';
            break;
        case 'likes':
            descOption.text = 'Most Liked';
            ascOption.text = 'Least Liked';
            break;
        case 'comments':
            descOption.text = 'Most Comments';
            ascOption.text = 'Least Comments';
            break;
        case 'title':
            descOption.text = 'Z-A';
            ascOption.text = 'A-Z';
            break;
        default:
            descOption.text = 'Descending';
            ascOption.text = 'Ascending';
    }
});
</script>
{{end}}
